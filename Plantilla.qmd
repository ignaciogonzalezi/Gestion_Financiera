---
title: "Hito 2"
author: "Ignacio González"
format: html
editor: visual
---

```{r configuraciones}
#| message: false
#| echo: false
# Esto ya debiera estar cargado en el proyecto en posit.cloud
# devtools::install_github("business-science/tidyquant")
# Loads tidyquant, lubridate, xts, quantmod, TTR, and PerformanceAnalytics
library(tidyverse)
library(tidyquant)  
```

## Descripción Activo y Contexto (Hito 1)

Fecha de entrega: Jueves 28 de Septiembre 23:59.

### Definición

Para el presente proyecto, se buscará hacer un análisis profundo sobre los comportamientos financieros del banco Bci (Banco de Crédito e Inversiones). El banco Bci, fundado en 1937, es uno de los bancos mas grandes y establecidos en el país. Bci ofrece una amplia gama de servicios, como banca personal y comercial, servicios de inversión, seguros y mucho más, pero nos enfocaremos específicamente en el activo de fondos mutuos. Los fondos mutuos son un instrumento de inversión que reúne los aportes monetarios de distintas personas, naturales o jurídicas, para invertirlos en diferentes instrumentos de mercado de valores como por ejemplo acciones, instrumentos de renta fija y/o de deuda.

Dentro del articulo "Asset management and investment banking" por Janis Berznins, el cual describe como los conflictos de interés en el negocio de gestión de activos de propiedad por bancos de inversión y conglomerados no bancarios son comunes, estudia como varían los alphas de los fondos mutuos en relación a cuando se invierte en aquellos que son propiedad de los bancos de inversión o cuando son invertidos por entidades no bancarias, dando como resultado una pérdida económica para los inversores que invierten con bancos, logrando una perdida económica de 4.9 billones por año.

```{r ETL}
#| echo: false
# Alternativamente Use FANG data set
# data("FANG") 
end <- as_date("2022-12-31")
# Get AAPL and AMZN Stock Prices
# AAPL <- tq_get("AAPL", get = "stock.prices", from = "2015-09-01", to = end)
# AMZN <- tq_get("AMZN", get = "stock.prices", from = "2000-01-01", to = end)
CMPC <- tq_get("BCI.SN", get = "stock.prices", from = "2000-01-01", to = end)
DOLAR <- tq_get("USDCLP=X", get = "stock.prices", from = "2000-01-01", to = end)
CL <- rbind(CMPC,DOLAR)
```

El activo BCI tiene un valor promedio para el intervalo igual a `r round(mean(CMPC$close),digits=0)`

```{r CMPCline}
#| echo: false
CMPC %>%
    ggplot(aes(x = date, y = close)) +
    geom_line() +
    labs(title = "BCI Line Chart", y = "Closing Price", x = "") + 
    theme_tq() +
  geom_hline(yintercept=mean(CMPC$close), linetype="dashed", color = "red")
```

```{r CMPCcandle}
#| warning: false
CMPC %>%
    ggplot(aes(x = date, y = close)) +
    geom_candlestick(aes(open = open, high = high, low = low, close = close)) +
    labs(title = "AAPL Candlestick Chart", y = "Closing Price", x = "") +
    theme_tq()
```

### Motivación

El banco BCI es una corporación financiera chilena controlada por la familia Yarur desde su fundación hace 76 años. Es el tercer mayor banco privado en Chile y cuenta con una sólida clasificación de riesgo internacional (A1: Moody´s, A: S&P y Fitch ratings: A-). Cuenta con 384 puntos de contacto a lo largo de Chile y presencia internacional en EEUU, Colombia, Perú, Brasil, México y España. Ofrece productos tales como cuentas corrientes, depósitos, préstamos, tarjetas de crédito, factoring, leasing, cash management, comercio exterior, fondos mutuos, asesorías financieras, operaciones de mesa de dinero, intermediación de acciones, bonos y seguros entre otros. Durante 2013 fue premiada en Chile como la empresa más transparente, con mejor gobierno corporativo, como el mejor grupo financiero, como la mejor banca privada, como la mejor administradora de fondos mutuos y reconocida con el mejor servicio y experiencia de clientes en la categoría bancos grandes (encuestas Ipsos/Izo).

### Contexto

Como se mencionó anteriormente, se hará un análisis financiero sobre el banco Bci pero enfocado particularmente en uno de sus fondos mutuos. Para continuar con el análisis, se investigará sobre variables que pueden afectar el activo, entregando estadística descriptiva y gráficos.

En primer lugar, se analizará el fondo mutuo Bci Acciones Globales, el cual es un fondo mutuo de serie de alto patrimonio el cual su objetivo principal es "El objeto de inversión del Fondo será principalmente invertir en cuotas del sub fondo extranjero, domiciliado en Luxemburgo, denominado"BCI AM SICAV - Global Equity Fund" (denominado en adelante el "Sub Fondo Extranjero"). El Fondo deberá mantener invertido al menos un 70% de sus activos en el Sub Fondo Extranjero."

Al ser un fondo de moneda extranjera, se tomará como variable el precio del colar en Chile, el cual en un periodo de 6 meses ha tenido un incremento de un 14.73% obteniendo un valor de \$909 CLP a la fecha.

Por último, se analizará el fondo "BCI AM SICAV - Global Equity Fund", el cual es el fondo extranjero en donde se invierte por lo menos el 70% de los activos del fondo a analizar. El fondo extranjero ha tenido un incremento de un 15,53% a la fecha y tiene un tamaño de 31.26 millones de dólares.

```{r context}
#| warning: false
#| echo: false
start <- end - weeks(6)

CL %>%
    filter(date >= start - days(2 * 15)) %>%
    ggplot(aes(x = date, y = close, group = symbol)) +
    geom_candlestick(aes(open = open, high = high, low = low, close = close)) +
    geom_ma(ma_fun = SMA, n = 15, color = "darkblue", size = 1) +
    labs(title = "CL Candlestick Chart", 
         subtitle = "Experimenting with Mulitple Stocks",
         y = "Closing Price", x = "") + 
    coord_x_date(xlim = c(start, end)) +
    facet_wrap(~ symbol, ncol = 2, scale = "free_y") +
    theme_tq()
```

::: columns
Rentabilidad Fondo Mutuo Bci Acciones Globales

::: {.column width="50%"}
![](photos/Imagen1.png){fig-align="left"}
:::
:::

Rentabilidad Fondo Extranjero

![](photos/imagen3.png){fig-align="left"}

### Análisis de Largo Plazo

#### Caracterización deuda (Aplicación cap. 15)

Como se mencionó anteriormente, nos focalizaremos en el fondo mutuo Acciones Globales. El Fondo Mutuo Bci Acciones Globales dirigido a inversionistas calificados de libre inversión extranjero - derivados, domiciliado y constituido bajo las Leyes chilenas. El objeto de inversión del Fondo será principalmente invertir en cuotas del sub fondo extranjero, domiciliado en Luxemburgo, denominado "BCI AM SICAV - Global EquityFund" (denominado en adelante el "Sub Fondo Extranjero"). El Fondo deberá mantener invertido al menos un 70% de sus activos en el Sub Fondo Extranjero.

El Sub Fondo Extranjero tiene como objeto invertir al menos el 70% de sus activos en un portfolio compuesto por instrumentos de capitalización UCIT´s o UCI´s, con exposición a activos en todo el mundo (desarrollado y emergente). Los instrumentos que utilice el Sub fondo están domiciliados en EEA (EuropeanEconomicArea).

La diversificación del activo total del fondo se distribuye en:

![](photos/imagen%202.jpg){fig-align="center"}

#### Caracterización de emisiones históricas (Aplicación cap. 20)

Los aportes del Fondo deberán ser pagados en pesos, el aporte recibido se expresará en cuotas del Fondo, utilizando el valor de la cuota correspondiente al mismo día de la recepción si este se efectuase antes del cierre de operaciones del Fondo o el valor de la cuota de día siguiente al de la recepción, si el aporte se efectuare con posterioridad a dicho cierre. En caso de colocaciones de Cuotas efectuadas en los sistemas de negociación bursátil autorizados por la Comisión para el mercado financiero, el precio de la Cuota será aquel que libremente estipulen las partes en esos sistemas de negociación.

#### Relación con activos derivados

El fondo analizado opera con instrumentos financieros derivados con la finalidad de tener una mayor cobertura de riesgos asociados a su inversión. El uso de instrumentos financieros derivados como cobertura también conlleva riesgos, como la posibilidad de que exista una correlación imperfecta entre el valor de los contratos de derivados y las inversiones objeto de cobertura, lo que puede llevar a multiplicar las perdidas o ganancias de la cartera.

Cuando el Fondo mantiene instrumentos financieros derivados que se pagan por compensación utiliza precios de mercado intermedios como una base para establecer valores razonables para compensar las posiciones de riesgo y aplica este precio de compra o venta a la posición neta abierta, según sea apropiado.

El valor razonable de activos y pasivos financieros que no son transados en un mercado activo como derivados extrabursátiles, también son determinados usando la información financiera disponible por la agencia de servicios de pricing RiskAmerica.

### Reporte grupal

El objetivo del portafolio es de largo plazo, por lo que se estudiará a más de un año,  buscando retornos altos en el largo plazo y teniendo presente el riesgo que implica esto. El portafolio es de renta variable, por lo que siempre se tendrá que considerar el riesgo que este tipo de inversiones implica.

Para poder obtener las ponderaciones del portafolio, se debe realizar un análisis a cada activo por invertir, donde se consideraron los Beta de cada acción y las industrias pertenecientes a cada activo.

Banco Bci está presente en la industria bancaria donde a grandes rasgos las inversiones están asociadas al manejo de carteras, en donde se analizará específicamente la inversión al Fondo Mutuo de Acciones Globales por parte del grupo Bci. Este fondo es de moneda extranjera el cual invierte principalmente en cuotas del subfondo extranjero, domiciliado en Luxemburgo, denominado "BCI AM SICAV - Global EquityFund".

Colbún es la tercera empresa más grande en el sector eléctrico chileno y ha tenido un aumento en activos en el último año. La empresa ha ido en un crecimiento constante desde que cambió de controlador, siendo dirigida principalmente por la familia Matte, bajo la empresa Minera Valparaíso. Los últimos años ha presentado un plan de largo plazo para generar en gran cantidad energía sustentable, con el fin de alinearse con las necesidades actuales. Aunque actualmente presenta un mes de rentabilidad negativa, su anualidad en los dos últimos años, es de alrededor de un 40%, lo que lo hace una empresa interesante para invertir, considerando un riesgo alto.

Cencosud está invirtiendo fuertemente en Estados Unidos, con una promesa de abrir una nueva tienda cada 33 días. Por lo tanto, las ganancias que obtenga la empresa serán a largo plazo cuando estas comiencen a operar, entonces se espera que el valor de la acción continúe creciendo moderadamente como ha sido a lo largo del año.

Según las estadísticas de Yahoo Finance, los betas de los activos tienen las siguientes cifras; 0.37 COLBÚN, 0.18 BCI, 0.55 CENCOSUD.

|          |       |
|----------|-------|
| Activo   | Betas |
| CENCOSUD | 0.55  |
| COLBUN   | 0.37  |
| BCI      | 0.18  |

Además, los retorno anuales de estos respectivamente son; 46.48% para COLBÚN, 11.9% para BCI y 29.97% para CENCOSUD.

|          |              |
|----------|--------------|
| Activo   | Rentabilidad |
| CENCOSUD | 29.97%       |
| COLBUN   | 46.48%       |
| BCI      | 11.9%        |

A este portafolio se le invertirá 100 millones de pesos chilenos con las siguientes ponderaciones:

|          |             |
|----------|-------------|
| Activo   | Ponderación |
| CENCOSUD | 30%         |
| COLBUN   | 50%         |
| BCI      | 20%         |

Este conjunto de inversiones, diseñado para personas que prefieren un nivel moderadamente alto de seguridad financiera, asigna el 30% de los recursos al activo más arriesgado, que tiene una mayor sensibilidad al riesgo (medida por su beta). Hemos asignado un 20% a BCI, ya que esperamos que tenga una volatilidad limitada debido a su rentabilidad moderada y su baja sensibilidad al riesgo. Además, hemos dado prioridad a los activos que han experimentado un mayor aumento en su valor durante el año, asignándoles una mayor ponderación en la cartera. Finalmente se ponderó un 50% de Colbún para poder obtener el retorno alto esperado, debido a que es una empresa que muestra un beta de 0.37, el cual no lo hace tan riesgosa y tiene los retornos esperados más altos.

```{r}
#| echo: false
# Alternativamente Use FANG data set
# data("FANG") 
end <- as_date("2022-12-31")
# Get AAPL and AMZN Stock Prices
# AAPL <- tq_get("AAPL", get = "stock.prices", from = "2015-09-01", to = end)
# AMZN <- tq_get("AMZN", get = "stock.prices", from = "2000-01-01", to = end)
CENCOSUD <- tq_get("CENCOSUD.SN", get = "stock.prices", from = "2000-01-01", to = end)
BCI <- tq_get("BCI.SN", get = "stock.prices", from = "2000-01-01", to = end)
COLBUN <- tq_get("COLBUN.SN", get = "stock.prices", from = "2000-01-01", to = end)

# Cargar las bibliotecas necesarias
library(tidyquant)
library(ggplot2)

# Definir las fechas de inicio y fin para el último año
end_date <- Sys.Date()
start_date <- end_date - years(1)

# Filtrar datos para las acciones de BCI, COBLUN y CENCOSUD
selected_stocks <- c("BCI.SN", "COLBUN.SN", "CENCOSUD.SN")
stock_data <- tq_get(selected_stocks, from = start_date, to = end_date)

# Asegurarse de que "symbol" sea una variable de factor
stock_data$symbol <- factor(stock_data$symbol)

# Crear gráficos de velas para las acciones seleccionadas
stock_data %>%
  ggplot(aes(x = date, y = close, group = symbol)) +
  geom_candlestick(aes(open = open, high = high, low = low, close = close)) +
  labs(title = "Candlestick Chart",
       subtitle = "Stock Price Movement (Last Year)",
       y = "Closing Price",
       x = "Date") +
  coord_x_date(xlim = c(start_date, end_date)) +
  facet_wrap(~ symbol, ncol = 1, scale = "free_y") +
  theme_tq()
```

### Aplicación Black-Scholes

Se valoriza correctamente una opción de compra del activo principal definido en el Hito 1, utilizando el modelo de Black-Scholes continuo apoyándose de un código replicable que compute el modelo. Se apoya de literatura para complementar su valorización.

```{python}
#| echo: false
import yfinance as yf
from datetime import datetime as dt
import datetime
from scipy.stats import norm
import math
from math import log, sqrt, exp

def black_scholes(S, K, T, r, sigma):
    d1 = (log(S / K) + (r + 0.5 * sigma ** 2) * T) / (sigma * sqrt(T))
    d2 = d1 - sigma * sqrt(T)
    option_price = K * exp(-r * T) * norm.cdf(-d2) - S * norm.cdf(-d1) #codigo para una put
    return option_price

t = yf.Ticker("SAN")
S = t.info["currentPrice"] # Precio actual del activo subyacente
stock_data = yf.download("SAN", start="2023-01-01", end="2023-10-24")
# Calcula la variación del rendimiento
stock_data["Returns"] = stock_data["Adj Close"].pct_change()
sigma = stock_data["Returns"].std() # Volatilidad del activo subyacente 
opcion = yf.Ticker("SAN240119P00007000")
K = opcion.info["strikePrice"] # Precio de ejercicio de la opción
expire_date = opcion.info["expireDate"]
fecha = datetime.datetime.utcfromtimestamp(expire_date)
T = ((fecha-dt.now()).days)/365# Tiempo hasta la expiración de la opción en años
bono = yf.download("^TNX", start="2023-01-01", end=dt.now(), interval = "1d")["Close"] #Resultados del bono de la tesorería
r = bono[-1]/100 #Se obtiene el rendimiento del bono mas reciente y se convierte a porcentaje (R).

precio = black_scholes(S, K, T, r, sigma)
print(precio)


```

### Modelo Adicional de valorizacion

Se explica junto con descripcion matemática (fórmulas) correcta un modelo alternativo para valorizar la accion haciendo revisión de literatura cientifica con tal de hacer una referencia a un artículo del modelo.

### Aplicacion modelo adicional

Se aplica el modelo alternativo apoyandose de un código replicable que computa el modelo.

```{python}
#| echo: false
import numpy as np
import yfinance as yf
from datetime import datetime as dt
import datetime
from scipy.stats import norm
import math
from math import log, sqrt, exp

def monte_carlo_option_pricing(S, K, T, r, sigma, num_simulations):
    z = np.random.standard_normal(num_simulations)
    ST = S * np.exp((r - 0.5 * sigma**2) * T + sigma * np.sqrt(T) * z)
    option_prices = np.maximum(K - ST, 0)
    option_price = np.exp(-r * T) * np.mean(option_prices)
    return option_price

t = yf.Ticker("SAN")
S = t.info["currentPrice"] # Precio actual del activo subyacente
stock_data = yf.download("SAN", start="2023-01-01", end="2023-10-24")
# Calcula la variación del rendimiento
stock_data["Returns"] = stock_data["Adj Close"].pct_change()
sigma = stock_data["Returns"][-1] # Volatilidad del activo subyacente 
opcion = yf.Ticker("SAN240119P00007000")
K = opcion.info["strikePrice"] # Precio de ejercicio de la opción
expire_date = opcion.info["expireDate"]
fecha = datetime.datetime.utcfromtimestamp(expire_date)
T = ((fecha-dt.now()).days)/365# Tiempo hasta la expiración de la opción en años
bono = yf.download("^TNX", start="2023-01-01", end=dt.now(), interval = "1d")["Close"] #Resultados del bono de la tesorería
r = bono[-1]/100 #Se obtiene el rendimiento del bono mas reciente y se convierte a porcentaje (R).
num_simulations = 10000


precioM = monte_carlo_option_pricing(S, K, T, r, sigma, num_simulations)
print(precioM)

```

### Análisis de contraste de ambos modelos

Se realiza una comparación de los resultados de ambos modelos de valorización explicando sus similitudes y diferencias.

### Reporte Grupal: Caso Administración

Se eligen uno de los siguientes casos con tal de replicar y responder sus preguntas de acuerdo al activo principal elegido:

Caso Administración de Capital de Trabajo de Keafer Manufacturing de la página 822 del ROSS.

Caso Administración de Efectivo de Richmond Corporation de la página 845 del ROSS.

Caso Administración de Efectivo de Braam Industries de la página 874 del ROSS.
